## Preamble

```
SEP: 0013a
Title: Issuer account funding protocol
Author: Tom Quisel
Status: Draft
Created: 2018-12-14
```

## Simple Summary

Account funding via issuer is a method for an issuer to fund a user's account without the user needing to take any further action to receive the funds. It begins at the point where an issuer has just received a deposit of assets external to the Stellar network (crypto, fiat, or other) from a user. It finishes with the user in possession of the deposited asset issued on the Stellar network and a Stellar account that has sufficient XLM reserve for them to get started using Stellar. It works in cases where the user's account is not yet created and cases where the users account has a low XLM balance. It uses CAP-13.


## Motivation

The current way that issuers handle depositing external (off-Stellar) funds into user accounts is defined briefly in [SEP-6](https://github.com/stellar/stellar-protocol/blob/master/ecosystem/sep-0006.md#1-success-no-additional-information-needed). It involves a four step process where:

1. A user initiates a deposit with an issuer, specifies the destination account ID for the deposit, and sends the deposit to the issuer's address
1. The issuer waits until the external asset deposit arrives in their account, and when it arrives uses some of the deposit value to create the user's account
1. The user waits until their account is created, and then adds a trustline for the deposit asset
1. The issuer waits until the trustline shows up, and then sends the on-chain asset to the user

This is a poor user experience because of the multiple intermediate steps that require the user or issuer to wait. This SEP uses CAP-13 to provide an experience where the user only has to wait once: between the time they send their external deposit to the issuer and the time the assets arrive in their account.

This SEP is an alternative to SEP-13, and has some extra desirable properties:

1. The wallet implementation is simpler
1. The issuer implementation is simpler
1. At no point does the user need to seek an external source of XLM to complete the deposit
1. The deposit ends up in the account ID originally specified by the user, avoiding situations where the user does not have XLM funds to merge accounts or the user's trustlines are spread across multiple accounts and they are unable to trade between assets they hold.

## Specification

The general setup is the case of an issuer (Isabel) processing a deposit of an external asset (FunBucks) for a specific user (Ulric). Ulric has already initiated a deposit with Isabel, and specified the Stellar account ID (U) where he wants the deposit to arrive.

We consider a few cases:

1. Ulric's account is not yet created
1. Ulric's account is created, but has no FunBucks trustline
1. Ulric's account is created, has a FunBucks trustline, but has insufficient XLM to create an offer
1. Ulric's account is created, has a FunBucks trustline, and has plenty of XLM

### Case 1: Account Needed

In this case, Isabel creates Ulric's account and deducts the cost from the value of the deposit.

1. Ulric deposits 10 FunBucks with Isabel, external to the Stellar network. Isabel must now transfer 10 FunBucks tokens to U on Stellar.
1. Isabel determines the amount of XLM that will be required to create a functional account for Ulric. The breakdown is:
    - 2 * `base reserve` (for the new account)
    - 1 `base reserve` (for the trustline)
    - 1 `base reserve` (so Ulric will be able to create an offer to sell more FunBucks once the deposit completes)
    - 10 * `base fee` (so Ulric is able to pay fees for his first several transactions)
1. In total, at the current `base reserve` of 0.5 XLM and `base fee` of 0.00001 XLM, that's 2.0001 XLM.
1. Isabel computes the value of that total in Funbucks at the market rate (say 2.0001 XLM = 1.5 FunBucks), and subtracts it from the deposit amount to get that Ulric will receive 8.5 FunBucks in his new account.
1. Isabel executes a transaction, which:
    - creates Ulric's account U
    - performs the CAP-13 AddBalance operation with FunBucks as the asset and U as the destination
    - pays 8.5 FunBucks to U
    - pays 0.5001 XLM to U
1. The next time Ulric looks at his account, it's fully created, contains his deposit, and is ready to use.

### Cases 2-4

These cases proceed just like Case 1, but remove unnecessary steps.

- Case 2 removes account creation and the 2 * `base reserve` deduction that Isabel needs to fund it
- Case 3 removes the Add Balance operation and the 1 * `base reserve` deduction that Isabel needs to fund it
- Case 4 removes the XLM deduction necessary to top up Ulric's account to the point where he has 1 * `base reserve` + 10 * `base fee` more XLM than his minimum reserve.
