## Preamble

CAP: 0013
Title: Change Trustlines to Balances
Author: Dan Robinson
Status: Draft
Created: 2018-11-14
Discussion: https://github.com/stellar/stellar-protocol/pull/213
Protocol version: TBD

## Simple Summary

This proposal would rename trustlines to "balances", and would add operations allowing any account to add a balance to any other account (as long as they also send the `base reserve` lumens to support that newly added balance), and to remove any of its own balances (including ones where the issuer has frozen the balance). It would also change the behavior of the AccountMerge operations so that balances in non-XLM assets are merged as well (except for AUTHORIZATION_REQUIRED assets for which one of the accounts does not have an authorized trustline, in which case the tokens in that balance are burned).

This proposal would bring the behavior of Stellar assets and accounts somewhat closer to the behavior of ERC20 tokens on Ethereum, where, by default, any asset can be sent to any user without permission. Under these principles, any asset-specific differentiatxion from these rules should be enforced by the asset issuer, via the AUTHORIZATION_REQUIRED flag (or other flags we may introduce, such as co-signed assets or [immutable accounts](https://github.com/stellar/stellar-protocol/pull/210)).

## Motivation

This makes it easier for an issuer, exchange, or other service provider to send new assets to users without any interaction from that user. [SEP-0013](https://github.com/stellar/stellar-protocol/pull/205) is an alternative partial solution to this problem that does not involve protocol changes.

These changes also fix some quirks in how the existing protocol handles merging accounts. Right now, it is impossible to presign or preauthorize transactions that will reliably merge an account into another account, because there is no way to reliably remove trustline (since a ChangeTrust operation to remove a trustline can be foiled by anyone else sending you the asset) or merge accounts that still have trustlines. Additionally, in the current protocol, any issuer with which you have a trustline can make it impossible to merge your account, simply by freezing that asset. This would prevent you from recovering the `2*base reserve` XLM for the account as well as the `1*base reserve` XLM for that asset. (If we end up rejecting this proposal, we could create a new proposal that would solve these issues in a different way.)

This proposal does not provide a way for accounts to opt out of having balances added to them, because it's not clear that would solve any real problem. Neither this flag (nor the current protocol) would protect accounts from receiving payments from parties that they don't want to receive payments from, in some asset that they are already accepting (or an asset, like lumens, that they cannot opt out of receiving). It therefore doesn't seem like adding such a flag would be worth the additional complexity and edge cases that it would lead to. This issue would better be addressed by a flag, like the one proposed in CAP-009, that would make an account immutable by _any_ external operations.

## Specification

### General changes

Rename "trustline" to "balance" in the documentation, internal implementations, and newly created operations. Horizon's API already uses "Balances" to refer to trustlines. Any external APIs that currently use the term "Trustline" or "Lines" (particularly including the ChangeTrust and AllowTrust ops) should not be changed.

The concept of limits on balances is deprecated, and we clearly communicate our intention to remove it in the future (in favor of all Balances having the "max" limit).

The Change Trust operation is deprecated. Removing it from the protocol (even years after being deprecated) may not be worth the potential cost, but we should clearly discourage its use, and encourage users to use AddBalance even for adding balances to their own accounts. (To make this easier, SDKs could set the `destination` on AddBalance to be sourceAccount by default, if no destination is provided.)

## New Operations

#### AddBalance

```c++
struct AddBalanceOp
{
    Asset asset;
    AccountID destination;
};
```

If `destination` does not have a balance for `asset`, the operation transfers base_reserve XLM from `sourceAccount` to `destination` (unless `sourceAccount` and `destination` are the same), and adds a balance for `asset` to `destination`.

If `asset` has the AUTHORIZATION_REQUIRED flag, the trustline's authorized flag is initialized to false.

If `destination` already has a balance for `asset`, this operation does nothing.

#### RemoveBalance

```c++
struct AddBalanceOp
{
    Asset asset;
};
```

Removes the `asset` balance from `sourceAccount`, sending any tokens stored in that balance to the issuer (i.e., burning them).
If there is no balance for `asset` on `sourceAccount`, this operation does nothing.
If there is a balance, this operation works regardless of whether the balance has the `authorized` flag set.

This (unlike ChangeTrust) allows an account to successfully remove a balance even if the issuer has frozen it or if some third party has unexpectedly sent some tokens to it, thus fixing two of the warts in the current protocol.

### Changes to existing operations

#### AccountMerge

Before merging, the `AccountMerge` operation should now check if there are any assets for which `sourceAccount` account has a balance and `destination` does not. If there are, it adds a balance in that asset to the destination account, transfers the entirety of `sourceAccount`'s balance to `destination`, and removes `sourceAccount`'s balance. (Since the reserve on `sourceAccount` will be paid into `destination` as part of this operation, this is guaranteed not to reduce the useable balance of the other account below minreserve, after the operation completes.)

If one of the assets that `sourceAccount` has a balance for has the AUTHORIZATION_REQUIRED flag set, and either `sourceAccount` or `destination` does not have an authorized balance in that asset, then all of the tokens of that asset in `sourceAccount` are sent to the issuer. A balance is still created for `destination` if it doesn't already exist, with the authorized flag initialized to false.

Making this a change to AccountMerge rather than creating a new operation seems preferable, because leaving AccountMerge as it is would be _more_ likely to break expected behavior, when combined with the changes described above. If anyone can add a balance to your account, it is especially important that AccountMerge not fail just because a trustline exists. (For example, adding the AddBalance operation without changing how AccountMerge works would create a critical vulnerability in the current Starlight protocol.)

It does not seem likely that any existing contracts or presigned transactions depend on the current behavior of AccountMerge failing when merging with unexpected balances.

## Backwards Compatibility

Wallet software will have to be changed to correctly notice third-party addition of new balances to the account. Any lumen-only wallet (which previously was assured that the account it managed would not receive unexpected assets) will have to make a choice whether to support additional assets, or just ignore any incoming payments of other assets.

The ability to add balances to other users' accounts is a significant conceptual change in the protocol. The above change to AccountMerge (in addition to being desirable in its own right) mitigates the most obvious negative consequence of that change, with the unfortunate side effect that there can be race conditions that cause newly received funds to get burned. I think this is a property of any change that makes it possible to deterministically remove trustlines or merge accounts.

I can't currently think of other ways that these changes could upset reasonable expectations, but the community might raise some.

## Alternatives

The AccountMerge change by itself would be sufficient to give us most of the desired functionality of AddBalance and RemoveBalance (since, instead of calling AddBalance to add a balance to an account, you could just create an account, add a balance to it, and then merge that account into the destination account). However, AddBalance makes adding a balance more efficient (requiring only one operation rather than three, and requiring only `1*base reserve` XLM to be sent, rather than `3*base reserve` XLM) and less roundabout.

[SEP-0013](https://github.com/stellar/stellar-protocol/pull/205), as mentioned above, is a potential solution to some of the same problems that does not involve protocol changes.

If we decide not to make protocol changes to allow adding balances, we still might want to add the RemoveBalance operation (which works unconditionally) in order to allow accounts to be merged predictably, and to prevent an issuer with which you have a trustline from preventing you from ever merging your account.
